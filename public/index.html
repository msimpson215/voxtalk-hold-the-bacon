<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VoxTalk Hello Voice</title>
</head>
<body>
  <h1>Hello from VoxTalk ðŸ‘‹</h1>
  <p>AI should greet you out loud on load.</p>
  <audio id="remote" autoplay playsinline></audio>

  <script>
    const rtAudio = document.getElementById('remote');

    async function initRealtime() {
      console.log("ðŸ”„ Fetching session...");
      const s = await fetch("/session", { method:"POST" });
      const { client_secret, model, voice } = await s.json();
      console.log("âœ… Got session keys:", { model, voice });

      const pc = new RTCPeerConnection();
      pc.ontrack = (ev)=> { rtAudio.srcObject = ev.streams[0]; };

      const dc = pc.createDataChannel("events");
      dc.onopen = () => {
        console.log("ðŸ“¡ Data channel open");
        // Tell AI to greet you
        dc.send(JSON.stringify({
          type:"response.create",
          response:{
            instructions:"Hello Marty, I'm here. Let's talk.",
            modalities:["audio"],
            voice:"verse"
          }
        }));
      };

      const offer = await pc.createOffer({ offerToReceiveAudio:true });
      await pc.setLocalDescription(offer);

      const r = await fetch(
        `https://api.openai.com/v1/realtime?model=${encodeURIComponent(model)}&voice=${voice}`,
        {
          method:"POST",
          headers:{
            "Authorization":`Bearer ${client_secret}`,
            "Content-Type":"application/sdp"
          },
          body: offer.sdp
        }
      );
      
      const answer = { type:"answer", sdp: await r.text() };
      await pc.setRemoteDescription(answer);
    }

    initRealtime().catch(err => console.error("ðŸ”¥ initRealtime error:", err));
  </script>
</body>
</html>
